
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Including instrument line shapes in simulation and fits &#8212; MATS 3 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Fitting and Simulating isotopes and molecules not in HITRAN" href="Fitting%20and%20Simulating%20isotopes%20and%20molecules%20not%20in%20HITRAN.html" />
    <link rel="prev" title="Incorporating CIA into fits" href="Incorporating%20CIA%20into%20fits.html" />
<link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>


<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>
<script>
$(document).ready(function(){
  // Mark external (non-nist.gov) A tags with class "external"
  //If the adress start with https and ends with nist.gov
  var re_nist = new RegExp('^https?:\/\/((^\/)*\.)*nist\\.gov(\/|$)');
  //Regex to find address that start with https
  var re_absolute_address = new RegExp('^((https?:)?\/\/)');
  $("a").each(function(){
    var url=$(this).attr('href');
    if(re_nist.test(url) || !re_absolute_address.test(url)){
      $(this).addClass('local');
    }else{
      //This a href appears to be external, so tag it
      $(this).addClass('external');
    }
  });
  // Add leaveNotice to external A elements
  $('a.external').leaveNotice();
});
</script>
<link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Fitting%20and%20Simulating%20isotopes%20and%20molecules%20not%20in%20HITRAN.html" title="Fitting and Simulating isotopes and molecules not in HITRAN"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Incorporating%20CIA%20into%20fits.html" title="Incorporating CIA into fits"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">MATS 3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Examples.html" accesskey="U">Examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Including instrument line shapes in simulation and fits</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="including-instrument-line-shapes-in-simulation-and-fits">
<h1>Including instrument line shapes in simulation and fits<a class="headerlink" href="#including-instrument-line-shapes-in-simulation-and-fits" title="Permalink to this heading">¶</a></h1>
<p>Provided in the MATS v2 release are several examples highlighting MATS capabilities, which can be found in the MATS <a class="reference external" href="https://github.com/usnistgov/MATS/tree/master/Examples">examples folder</a>.</p>
<p>MATS has added the capability to simulate and fit spectra using an instrument lineshape.  MATS automatically loads the slit functions defined in HAPI, but could use any slit function with the form slit_function(x, resolution) or slit_function(x, [resolutions]).  MATS uses a slight variation of the HAPI convolveSpectrumSame, where the <a href="#id1"><span class="problematic" id="id2">arange_</span></a> function was redefined to address an integer/float bug in the underlying np.linspace call.  This implementation currently assumes an equal wavenumber spacing based on the application of the slit function calculation.</p>
<p><a class="reference external" href="https://github.com/usnistgov/MATS/tree/master/Examples/Instrument_Lineshape">The example below simulates the same spectrum and applies the different HAPI instrument line shapes.</a>   The simulated molefraction is perturbted and then floated during a fit.</p>
<section id="simulate-spectra-with-ils">
<h2>Simulate Spectra with ILS<a class="headerlink" href="#simulate-spectra-with-ils" title="Permalink to this heading">¶</a></h2>
<p>Module import follows from the <a class="reference internal" href="Fitting%20Experimental%20Spectra.html#fitting-experimental-spectra"><span class="std std-ref">Fitting Experimental Spectra</span></a> and <a class="reference internal" href="Fitting%20Synthetic%20Spectra.html#fitting-synthetic-spectra"><span class="std std-ref">Fitting Synthetic Spectra</span></a> examples with additional details on how to simulate spectra found in <a class="reference internal" href="Fitting%20Synthetic%20Spectra.html#fitting-synthetic-spectra"><span class="std std-ref">Fitting Synthetic Spectra</span></a> and the source documentation.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">MATS.linelistdata</span> <span class="kn">import</span> <span class="n">linelistdata</span>
<span class="kn">import</span> <span class="nn">MATS.hapi</span> <span class="k">as</span> <span class="nn">hapi</span>

<span class="c1"># Shared Simulation and Fit Parameters</span>
<span class="n">IntensityThreshold</span> <span class="o">=</span> <span class="mf">1e-30</span> <span class="c1">#intensities must be above this value to be simulated</span>
<span class="n">Fit_Intensity</span> <span class="o">=</span> <span class="mf">1e-24</span><span class="c1">#intensities must be above this value for the line to be fit</span>
<span class="n">wave_range</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="c1">#range outside of experimental x-range to simulate</span>
<span class="n">IntensityThreshold</span> <span class="o">=</span> <span class="mf">1e-30</span> <span class="c1">#intensities must be above this value to be simulated</span>
<span class="n">segment_column</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">order_baseline_fit</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">etalon</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">SNR</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">resolution</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">molefraction</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">}</span>
<span class="n">wave_min</span> <span class="o">=</span> <span class="mi">6320</span>
<span class="n">wave_max</span> <span class="o">=</span> <span class="mi">6340</span>
<span class="n">wave_step</span> <span class="o">=</span> <span class="mf">0.01</span>
</pre></div>
</div>
<p>When fitting spectra, the simulated spectral range is the minimum and maximum wavenumbers in your dataset +/- an extra spectral window defined in this example by the wave_range parameter.  This is used to truncate the input line list when generating the Parameter linelist used in fitting to increase the fit speed.  However, this trunctation doesn’t occur when simulating spectra, which can lead to far-wing effects as the default is to calculate each transition to +/- 25 half-widths from the line center.  For this example, we are truncating input line list used for the simulation to match the fit simulation window.  Alternatively, the wave_range parameter could be increased substantially to include these far-wing impacts.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">PARAM_LINELIST</span> <span class="o">=</span> <span class="n">linelistdata</span><span class="p">[</span><span class="s1">&#39;CO2_30012&#39;</span><span class="p">]</span>
<span class="n">PARAM_LINELIST</span> <span class="o">=</span> <span class="n">PARAM_LINELIST</span><span class="p">[(</span><span class="n">PARAM_LINELIST</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wave_max</span> <span class="o">+</span> <span class="n">wave_range</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span><span class="o">&gt;=</span> <span class="n">wave_min</span> <span class="o">-</span> <span class="n">wave_step</span><span class="p">)]</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="MATS.html#MATS.spectrum.Spectrum" title="MATS.spectrum.Spectrum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Spectrum</span></code></a> object definitions below show how to use the ILS_function, ILS_resolution, and ILS_wing (defines the length of the ILS slit function to use in the convolution, such that the length is +/- ILS_wing / spectrum stepsize) to define the ILS function. The outputs below show the generated spectrum for each ILS_function</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_rectangular</span> <span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Rectangular&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">}</span> <span class="p">,</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_RECTANGULAR</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/rectangular.png" src="_images/rectangular.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_triangular</span><span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Triangular&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_TRIANGULAR</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/triangular.png" src="_images/triangular.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_gaussian</span> <span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_GAUSSIAN</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/gaussian.png" src="_images/gaussian.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_dispersion</span> <span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Dispersion&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_DISPERSION</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/dispersion.png" src="_images/dispersion.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_cosinus</span> <span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Cosinus&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_COSINUS</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/cosinus.png" src="_images/cosinus.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_diffraction</span> <span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Diffraction&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_DIFFRACTION</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/diffraction.png" src="_images/diffraction.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_michelson</span> <span class="o">=</span>  <span class="n">MATS</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span><span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">,</span> <span class="n">wave_step</span><span class="p">,</span>
                             <span class="n">SNR</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">baseline_terms</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mf">22.85</span><span class="p">,</span>
                             <span class="n">pressure</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span>
                              <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Michelson&#39;</span><span class="p">,</span>
                            <span class="n">molefraction</span> <span class="o">=</span>  <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="mf">0.01</span><span class="p">},</span> <span class="n">ILS_function</span> <span class="o">=</span> <span class="n">SLIT_MICHELSON</span><span class="p">,</span> <span class="n">ILS_resolution</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">ILS_wing</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/michelson.png" src="_images/michelson.png" />
</section>
<section id="generate-dataset-and-fit-parameters">
<h2>Generate Dataset and Fit Parameters<a class="headerlink" href="#generate-dataset-and-fit-parameters" title="Permalink to this heading">¶</a></h2>
<p>The dataset and fit parameters are generated with instances of the <a class="reference internal" href="MATS.html#MATS.dataset.Dataset" title="MATS.dataset.Dataset"><code class="xref py py-class docutils literal notranslate"><span class="pre">Dataset</span></code></a> and</p>
<p><a class="reference internal" href="MATS.html#MATS.generate_fitparam_file.Generate_FitParam_File" title="MATS.generate_fitparam_file.Generate_FitParam_File"><code class="xref py py-class docutils literal notranslate"><span class="pre">Generate_FitParam_File</span></code></a> classes. Additionally, the initial CO2 molefraction is perturbed within 2% of the simulated mole fraction.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SPECTRA</span> <span class="o">=</span> <span class="n">MATS</span><span class="o">.</span><span class="n">Dataset</span><span class="p">([</span> <span class="n">spec_rectangular</span><span class="p">,</span> <span class="n">spec_triangular</span><span class="p">,</span> <span class="n">spec_gaussian</span><span class="p">,</span> <span class="n">spec_dispersion</span><span class="p">,</span> <span class="n">spec_cosinus</span><span class="p">,</span>
                            <span class="n">spec_diffraction</span><span class="p">,</span> <span class="n">spec_michelson</span><span class="p">],</span>  <span class="s1">&#39;ILS Study&#39;</span><span class="p">,</span> <span class="n">PARAM_LINELIST</span><span class="p">)</span>
<span class="n">BASE_LINELIST</span> <span class="o">=</span> <span class="n">SPECTRA</span><span class="o">.</span><span class="n">generate_baseline_paramlist</span><span class="p">()</span>

<span class="n">BASE_LINELIST</span><span class="p">[</span><span class="s1">&#39;molefraction_CO2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BASE_LINELIST</span><span class="p">[</span><span class="s1">&#39;molefraction_CO2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">BASE_LINELIST</span><span class="p">[</span><span class="s1">&#39;molefraction_CO2&#39;</span><span class="p">]))</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span> <span class="c1">#Adjust the mole fraction of each sample by a mole fraction of random value normally distributed 2%</span>




<span class="n">FITPARAMS</span> <span class="o">=</span> <span class="n">MATS</span><span class="o">.</span><span class="n">Generate_FitParam_File</span><span class="p">(</span><span class="n">SPECTRA</span><span class="p">,</span> <span class="n">PARAM_LINELIST</span><span class="p">,</span> <span class="n">BASE_LINELIST</span><span class="p">,</span>
                                        <span class="n">lineprofile</span> <span class="o">=</span> <span class="s1">&#39;SDNGP&#39;</span><span class="p">,</span> <span class="n">linemixing</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                           <span class="n">fit_intensity</span> <span class="o">=</span> <span class="n">Fit_Intensity</span><span class="p">,</span> <span class="n">threshold_intensity</span> <span class="o">=</span> <span class="n">IntensityThreshold</span><span class="p">,</span>
                                           <span class="n">nu_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sw_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">gamma0_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">delta0_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                            <span class="n">aw_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                            <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">eta_constrain</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linemixing_constrain</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>


<span class="n">FITPARAMS</span><span class="o">.</span><span class="n">generate_fit_param_linelist_from_linelist</span><span class="p">(</span><span class="n">vary_nu</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span> <span class="n">vary_sw</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span>
                                                 <span class="n">vary_gamma0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="n">vary_n_gamma0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span>
                                                 <span class="n">vary_delta0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="n">vary_n_delta0</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span>
                                                 <span class="n">vary_aw</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span> <span class="n">vary_n_gamma2</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span>
                                                 <span class="n">vary_as</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span> <span class="n">vary_n_delta2</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span>
                                                 <span class="n">vary_nuVC</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span> <span class="n">vary_n_nuVC</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}},</span>
                                                 <span class="n">vary_eta</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">vary_linemixing</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:{</span><span class="mi">1</span><span class="p">:</span><span class="kc">False</span><span class="p">}})</span>

<span class="n">FITPARAMS</span><span class="o">.</span><span class="n">generate_fit_baseline_linelist</span><span class="p">(</span><span class="n">vary_baseline</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">vary_molefraction</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span><span class="kc">True</span><span class="p">},</span> <span class="n">vary_ILS_res</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>In the <a class="reference internal" href="MATS.html#MATS.generate_fitparam_file.Generate_FitParam_File.generate_fit_baseline_linelist" title="MATS.generate_fitparam_file.Generate_FitParam_File.generate_fit_baseline_linelist"><code class="xref py py-func docutils literal notranslate"><span class="pre">Generate_FitParam_File.generate_fit_baseline_linelist()</span></code></a> function, in addition to the normal baseline parameters the ILS resolution parameters are also fittable parameters.  Additionally, this is coded in such a way that each ILS_function has a unique resolution parameter.  This allows for different spectra to have different ILS functions and the baseline linelist table adequately accounts for this. Subset of a <a class="reference internal" href="MATS.html#MATS.generate_fitparam_file.Generate_FitParam_File.generate_fit_baseline_linelist" title="MATS.generate_fitparam_file.Generate_FitParam_File.generate_fit_baseline_linelist"><code class="xref py py-func docutils literal notranslate"><span class="pre">Generate_FitParam_File.generate_fit_baseline_linelist()</span></code></a> output highlights this.  While floating the resolution parameters is possible, it should be done with caution as all other parameters are dependent on this value, so correlation and poor fits are likely.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Spectrum</span> <span class="n">Number</span>    <span class="n">SLIT_RECTANGULAR_res_0</span>    <span class="n">SLIT_RECTANGULAR_res_0_err</span>    <span class="n">SLIT_RECTANGULAR_res_0_vary</span>    <span class="n">SLIT_MICHELSON_res_0</span>
<span class="mi">1</span>                      <span class="mf">0.25</span>                                          <span class="mi">0</span>                                                         <span class="kc">False</span>                                                  <span class="mi">0</span>
<span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
<span class="mi">7</span>                      <span class="mi">0</span>                                             <span class="mi">0</span>                                                         <span class="kc">False</span>                                                  <span class="mf">0.25</span>
</pre></div>
</div>
</section>
<section id="fit-data">
<h2>Fit Data<a class="headerlink" href="#fit-data" title="Permalink to this heading">¶</a></h2>
<p>In this example only the sample concentration is allowed to float, which is a spectrum dependent parameter.  At this SNR all of the results yield fit mole fractions very similar to the simulated value.  The plot below shows the relative Bias in the fit mole fraction with error bars equal to the relative fit uncertainty for each ILS.  Note that this is only one iteration and not generalizable.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fit_data</span> <span class="o">=</span> <span class="n">MATS</span><span class="o">.</span><span class="n">Fit_DataSet</span><span class="p">(</span><span class="n">SPECTRA</span><span class="p">,</span><span class="s1">&#39;Baseline_LineList&#39;</span><span class="p">,</span> <span class="s1">&#39;Parameter_LineList&#39;</span><span class="p">,</span> <span class="n">minimum_parameter_fit_intensity</span> <span class="o">=</span> <span class="n">Fit_Intensity</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">fit_data</span><span class="o">.</span><span class="n">generate_params</span><span class="p">()</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
 <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;_res_&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
     <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">min</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">fit_data</span><span class="o">.</span><span class="n">fit_data</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">())</span>
<span class="n">fit_data</span><span class="o">.</span><span class="n">residual_analysis</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indv_resid_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fit_data</span><span class="o">.</span><span class="n">update_params</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">SPECTRA</span><span class="o">.</span><span class="n">generate_summary_file</span><span class="p">(</span><span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/ILS_Function_mole_fraction.png" src="_images/ILS_Function_mole_fraction.png" />
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="Incorporating%20CIA%20into%20fits.html"
                          title="previous chapter">Incorporating CIA into fits</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="Fitting%20and%20Simulating%20isotopes%20and%20molecules%20not%20in%20HITRAN.html"
                          title="next chapter">Fitting and Simulating isotopes and molecules not in HITRAN</a></p>
  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Fitting%20and%20Simulating%20isotopes%20and%20molecules%20not%20in%20HITRAN.html" title="Fitting and Simulating isotopes and molecules not in HITRAN"
             >next</a> |</li>
        <li class="right" >
          <a href="Incorporating%20CIA%20into%20fits.html" title="Incorporating CIA into fits"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">MATS 3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Examples.html" >Examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Including instrument line shapes in simulation and fits</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>