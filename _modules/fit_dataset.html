
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MATS.fit_dataset &#8212; MATS 3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://pages.nist.gov/nist-header-footer/css/nist-combined.css">
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
  <script src="https://pages.nist.gov/nist-header-footer/js/nist-header-footer.js" type="text/javascript" defer="defer"></script>


<script type="text/javascript" src="https://pages.nist.gov/leaveNotice/js/jquery.leaveNotice-nist.min.js"></script>
<script>
$(document).ready(function(){
  // Mark external (non-nist.gov) A tags with class "external"
  //If the adress start with https and ends with nist.gov
  var re_nist = new RegExp('^https?:\/\/((^\/)*\.)*nist\\.gov(\/|$)');
  //Regex to find address that start with https
  var re_absolute_address = new RegExp('^((https?:)?\/\/)');
  $("a").each(function(){
    var url=$(this).attr('href');
    if(re_nist.test(url) || !re_absolute_address.test(url)){
      $(this).addClass('local');
    }else{
      //This a href appears to be external, so tag it
      $(this).addClass('external');
    }
  });
  // Add leaveNotice to external A elements
  $('a.external').leaveNotice();
});
</script>
<link rel="stylesheet" type="text/css" href="https://pages.nist.gov/leaveNotice/css/jquery.leaveNotice.css" />


  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MATS 3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MATS.fit_dataset</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for MATS.fit_dataset</h1><div class="highlight"><pre>
<span></span><span class="c1">#Import Packages</span>
<span class="c1"># from .Utilities import *</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RegularGridInterpolator</span>
<span class="kn">from</span> <span class="nn">.hapi</span> <span class="kn">import</span> <span class="n">ISO</span><span class="p">,</span> <span class="n">PYTIPS2017</span><span class="p">,</span> <span class="n">PYTIPS2011</span><span class="p">,</span> <span class="n">PYTIPS2021</span><span class="p">,</span> <span class="n">pcqsdhc</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">molecularMass</span><span class="p">,</span> <span class="n">etalon</span><span class="p">,</span> <span class="n">convolveSpectrumSame</span>
<span class="kn">from</span> <span class="nn">.codata</span> <span class="kn">import</span> <span class="n">CONSTANTS</span>
<span class="kn">from</span> <span class="nn">.o2_cia_karman</span> <span class="kn">import</span> <span class="n">o2_cia_karman_model</span>

<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Minimizer</span><span class="p">,</span>  <span class="n">Parameters</span>


<div class="viewcode-block" id="HTP_from_DF_select"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.HTP_from_DF_select">[docs]</a><span class="k">def</span> <span class="nf">HTP_from_DF_select</span><span class="p">(</span><span class="n">linelist</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">wing_cutoff</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_wavenumbers</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_method</span> <span class="o">=</span> <span class="s1">&#39;wing_cutoff&#39;</span><span class="p">,</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">296</span><span class="p">,</span> <span class="n">molefraction</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="n">ISO</span><span class="p">,</span>
                <span class="n">natural_abundance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">abundance_ratio_MI</span> <span class="o">=</span> <span class="p">{},</span>  <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">diluent</span> <span class="o">=</span> <span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="n">IntensityThreshold</span> <span class="o">=</span> <span class="mf">1e-30</span><span class="p">,</span> 
                <span class="n">TIPS</span> <span class="o">=</span> <span class="n">PYTIPS2021</span><span class="p">,</span> <span class="n">compressability_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the absorbance (ppm/cm) based on input line list, wavenumbers, and spectrum environmental parameters.</span>

<span class="sd">    Outline</span>

<span class="sd">    1.  Uses provided wavenumber axis</span>

<span class="sd">    2.  Calculates the molecular density from pressure and temperature</span>

<span class="sd">    3.  Sets up Diluent dictionary if not given as input</span>

<span class="sd">    4.  Calculates line intensity and doppler width at temperature for all lines</span>

<span class="sd">    5.  Loops through each line in the line list and loops through each diluent, generating a line parameter at experimental conditions</span>
<span class="sd">        that is the appropriate ratio of each diluent species corrected for pressure and temperature.  For each line, simulate the line for the given simulation cutoffs and add to cross section</span>

<span class="sd">    6.  Return wavenumber and cross section arrays</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    linelist : dataframe</span>
<span class="sd">        Pandas dataframe with the following column headers, where species corresponds to each diluent in the spectrum objects included in the dataset and nominal temperature corresponds to the nominal temperatures included in the dataset:</span>
<span class="sd">            nu = wavenumber of the spectral line transition (cm-1) in vacuum</span>

<span class="sd">            sw = The spectral line intensity (cm−1/(molecule⋅cm−2)) at Tref=296K</span>

<span class="sd">            elower = The lower-state energy of the transition (cm-1)</span>

<span class="sd">            molec_id = HITRAN molecular ID number</span>

<span class="sd">            local_iso_id = HITRAN isotopologue ID number</span>

<span class="sd">            gamma_0_species = half width at half maximum (HWHM) (cm−1/atm) at Tref=296K and reference pressure pref=1atm for a given diluent (air, self, CO2, etc.)</span>

<span class="sd">            n_gamma0_species = The coefficient of the temperature dependence of the half width</span>

<span class="sd">            delta_0_species = The pressure shift (cm−1/atm) at Tref=296K and pref=1atm of the line position with respect to the vacuum transition wavenumber νij</span>

<span class="sd">            n_delta0_species = the coefficient of the temperature dependence of the pressure shift</span>

<span class="sd">            SD_gamma_species = the ratio of the speed dependent width to the half-width at reference temperature and pressure</span>

<span class="sd">            n_gamma2_species = the coefficient of the temperature dependence of the speed dependent width NOTE: This is the temperature dependence of the speed dependent width not the ratio of the speed dependence to the half-width</span>

<span class="sd">            SD_delta_species = the ratio of the speed dependent shift to the collisional shift at reference temperature and pressure</span>

<span class="sd">            n_delta2_species = the coefficient of the temperature dependence of the speed dependent shift NOTE: This is the temperature dependence of the speed dependent shift not the ratio of the speed dependence to the shift</span>

<span class="sd">            nuVC_species = dicke narrowing term at reference temperature</span>

<span class="sd">            n_nuVC_species = coefficient of the temperature dependence of the dicke narrowing term</span>

<span class="sd">            eta_species = the correlation parameter for the VC and SD effects</span>

<span class="sd">            y_species = linemixing term </span>
<span class="sd">            </span>
<span class="sd">            n_y_species = temperature dependence of linemixing term                            </span>
<span class="sd">                                         </span>
<span class="sd">    waves : array</span>
<span class="sd">        1-D array comprised of wavenumbers (cm-1) to use as x-axis for simulation.</span>
<span class="sd">    wing_cutoff : float, optional</span>
<span class="sd">        number of half-widths for each line to be calculated for. The default is 50.</span>
<span class="sd">    wing_wavenumbers : float, optional</span>
<span class="sd">        number of wavenumber for each line to be calculated. The default is 50.</span>
<span class="sd">    wing_method : str, optional</span>
<span class="sd">        defines which wing cut-off option to use.  Options are wing_cutoff or wing_wavenumbers The default is &#39;wing_cutoff&#39;.</span>
<span class="sd">    p : float, optional</span>
<span class="sd">        pressure for simulation in atmospheres. The default is 1.</span>
<span class="sd">    T : float, optional</span>
<span class="sd">        temperature for simulation in kelvin. The default is 296.</span>
<span class="sd">    molefraction : dict, optional</span>
<span class="sd">        takes the form {molecule_id : mole fraction, molecule_id: mole fraction, . . .}. The default is {}.</span>
<span class="sd">    isotope_list : dict, optional</span>
<span class="sd">        provides opportunity to specify the isotope look-up table.  Default is ISO, which is from HAPI.  If not using ISO, then must use this format and suggested you use function to add to ISO</span>
<span class="sd">    natural_abundance : bool, optional</span>
<span class="sd">        True indicates the sample is at natural abundance. The default is True.</span>
<span class="sd">    abundance_ratio_MI : dictionary, optional</span>
<span class="sd">        If sample is not at natural abundance, then the natural abundance defines the enrichment factor compared to natural abundance(ie a sample where the main isotope is the only isotope would have a 1/natural abundance as the enrichment factor). Defined as {M:{I:enrichment factor, I: enrichment factor, I: enrichment factor}, . . . }. The default is {}.</span>
<span class="sd">    Diluent : dict, optional</span>
<span class="sd">        contains the species as the key with the value being the abundance of that diluent in the sample, ie {&#39;He&#39;:0.5, &#39;self&#39;:0.5}. The default is {}.</span>
<span class="sd">    diluent : str, optional</span>
<span class="sd">        If Diluent = {}, then this value will be used to set the only diluent to be equal to this diluent. The default is &#39;air&#39;.</span>
<span class="sd">    IntensityThreshold : float, optional</span>
<span class="sd">        minimum line intensity that will be simulated. The default is 1e-30.</span>
<span class="sd">    TIPS : definition, optional</span>
<span class="sd">        selects the HAPI provided TIPS version to use for the partition function</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavenumbers : array</span>
<span class="sd">        wavenumber axis that should match the input waves</span>
<span class="sd">    xsect : array</span>
<span class="sd">        simulated cross section as a function of wavenumbers (ppm/cm)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Generate X-axis for simulation</span>
    <span class="n">wavenumbers</span> <span class="o">=</span> <span class="n">waves</span>

    <span class="c1">#Set Omegas to X-values</span>
    <span class="n">Xsect</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">)</span>

    <span class="c1">#define reference temperature/pressure and calculate molecular density</span>
    <span class="n">Tref</span> <span class="o">=</span> <span class="mf">296.</span> <span class="c1"># K</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># atm</span>
    
    <span class="n">mol_dens</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span> <span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;cpa_atm&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>
    <span class="n">mol_dens</span> <span class="o">=</span> <span class="n">mol_dens</span> <span class="o">/</span> <span class="n">compressability_factor</span>


    <span class="c1">#Sets-up the  Diluent (currently limited to air or self, unless manual input in Diluent)</span>
    <span class="c1">#Sets-up the  Diluent (currently limited to air or self, unless manual input in Diluent)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Diluent</span><span class="p">:</span>
         <span class="c1">#Diluent = {diluent:1.}</span>
         <span class="k">if</span> <span class="n">diluent</span> <span class="o">==</span> <span class="s1">&#39;air&#39;</span><span class="p">:</span>
             <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{</span><span class="n">diluent</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="mf">28.95734</span><span class="p">}}</span>
         <span class="k">elif</span> <span class="n">diluent</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
            <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{</span><span class="n">diluent</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span>

    <span class="c1">#Calculate line intensity</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;abun_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">molec</span> <span class="ow">in</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">linelist</span> <span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIPS</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIPS</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span><span class="n">Tref</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molecularMass</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="n">isotope_list</span><span class="p">)</span> <span class="c1">#* 1.66053873e-27 * 1000 #cmassmol and kg conversion</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">natural_abundance</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">abundance_ratio_MI</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;abun_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abundance_ratio_MI</span><span class="p">[</span><span class="n">molec</span><span class="p">][</span><span class="n">iso</span><span class="p">]</span>

    <span class="c1">#linelist[&#39;LineIntensity&#39;] = EnvironmentDependency_Intensity(linelist[&#39;sw&#39;],T,Tref,linelist[&#39;SigmaT&#39;],linelist[&#39;SigmaTref&#39;],linelist[&#39;elower&#39;],linelist[&#39;nu&#39;])</span>

    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;elower&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">T</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;elower&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Tref</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Tref</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">isotope_list</span> <span class="o">!=</span> <span class="n">ISO</span><span class="p">:</span>
        <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)][</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1">#Calculate Doppler Broadening</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="c1"># Calculated Line Parameters across Broadeners</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">Diluent</span><span class="p">:</span>
        <span class="n">abun</span> <span class="o">=</span> <span class="n">Diluent</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>
        <span class="c1">#Gamma0: pressure broadening coefficient HWHM</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;gamma0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_gamma0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]))</span>
        <span class="c1">#Delta0</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift0&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">((</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;delta0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_delta0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">Tref</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span>
        <span class="c1">#Gamma2</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma2&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SD_gamma_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;gamma0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_gamma2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]))</span>
        <span class="c1">#Delta2</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift2&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">((</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SD_delta_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;delta0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_delta2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">Tref</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span>
        <span class="c1">#nuVC</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">])))</span>
        <span class="c1">#eta</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;eta_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span><span class="n">abun</span>
        <span class="c1">#Line mixing</span>
        <span class="c1">#linelist[&#39;Y&#39;] += abun*(linelist[&#39;y_%s&#39;%species] *(p/pref))</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;y_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_y_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">])))</span>

    <span class="c1">#Line profile simulation cut-off determination</span>
    <span class="k">if</span> <span class="n">wing_method</span> <span class="o">==</span> <span class="s1">&#39;wing_cutoff&#39;</span><span class="p">:</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5346</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.2166</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">wing_cutoff</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wing_wavenumbers</span>

    <span class="c1">#Enforce  Line Intensity Simulation Threshold</span>
    <span class="n">linelist</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span><span class="o">&gt;=</span> <span class="n">IntensityThreshold</span><span class="p">]</span>

    <span class="c1">#For each line calculate spectrum and add to the global spectrum</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">linelist</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">BoundIndexLower</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">])</span>
        <span class="n">BoundIndexUpper</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">])</span>
        <span class="n">lineshape_vals_real</span><span class="p">,</span> <span class="n">lineshape_vals_imag</span> <span class="o">=</span> <span class="n">pcqsdhc</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Gamma2&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Shift0&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Shift2&#39;</span><span class="p">],</span>
                                                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">],</span><span class="n">wavenumbers</span><span class="p">[</span><span class="n">BoundIndexLower</span><span class="p">:</span><span class="n">BoundIndexUpper</span><span class="p">])</span>
        <span class="n">Xsect</span><span class="p">[</span><span class="n">BoundIndexLower</span><span class="p">:</span><span class="n">BoundIndexUpper</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mol_dens</span>  <span class="o">*</span> \
                                                    <span class="n">molefraction</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;abun_ratio&#39;</span><span class="p">]</span> <span class="o">*</span> \
                                                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lineshape_vals_real</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">lineshape_vals_imag</span><span class="p">)</span>

    <span class="c1"># Return two arrays corresponding to the wavenumber axis and the calculated cross-section</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Xsect</span><span class="p">))</span></div>

<div class="viewcode-block" id="HTP_wBeta_from_DF_select"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.HTP_wBeta_from_DF_select">[docs]</a><span class="k">def</span> <span class="nf">HTP_wBeta_from_DF_select</span><span class="p">(</span><span class="n">linelist</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">wing_cutoff</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_wavenumbers</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_method</span> <span class="o">=</span> <span class="s1">&#39;wing_cutoff&#39;</span><span class="p">,</span>
                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="mi">296</span><span class="p">,</span> <span class="n">molefraction</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="n">ISO</span><span class="p">,</span>
                <span class="n">natural_abundance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">abundance_ratio_MI</span> <span class="o">=</span> <span class="p">{},</span>  <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">diluent</span> <span class="o">=</span> <span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="n">IntensityThreshold</span> <span class="o">=</span> <span class="mf">1e-30</span><span class="p">,</span> 
                <span class="n">TIPS</span> <span class="o">=</span> <span class="n">PYTIPS2021</span><span class="p">,</span> <span class="n">compressability_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the absorbance (ppm/cm) based on input line list, wavenumbers, and spectrum environmental parameters with capability of incorporating the beta correction to the Dicke Narrowing proposed in Analytical-function correction to the Hartmann–Tran profile for more reliable representation of the Dicke-narrowed molecular spectra.</span>

<span class="sd">    Outline</span>

<span class="sd">    1.  Uses provided wavenumber axis</span>

<span class="sd">    2.  Calculates the molecular density from pressure and temperature</span>

<span class="sd">    3.  Sets up Diluent dictionary if not given as input</span>

<span class="sd">    4.  Calculates line intensity and doppler width at temperature for all lines</span>

<span class="sd">    5.  Loops through each line in the line list and loops through each diluent, generating a line parameter at experimental conditions</span>
<span class="sd">        that is the appropriate ratio of each diluent species corrected for pressure and temperature.  For each line, simulate the line for the given simulation cutoffs and add to cross section</span>

<span class="sd">    6.  Return wavenumber and cross section arrays</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    linelist : dataframe</span>
<span class="sd">        Pandas dataframe with the following column headers, where species corresponds to each diluent in the spectrum objects included in the dataset and nominal temperature corresponds to the nominal temperatures included in the dataset:</span>
<span class="sd">            nu = wavenumber of the spectral line transition (cm-1) in vacuum</span>

<span class="sd">            sw = The spectral line intensity (cm−1/(molecule⋅cm−2)) at Tref=296K</span>

<span class="sd">            elower = The lower-state energy of the transition (cm-1)</span>

<span class="sd">            molec_id = HITRAN molecular ID number</span>

<span class="sd">            local_iso_id = HITRAN isotopologue ID number</span>

<span class="sd">            gamma_0_species = half width at half maximum (HWHM) (cm−1/atm) at Tref=296K and reference pressure pref=1atm for a given diluent (air, self, CO2, etc.)</span>

<span class="sd">            n_gamma0_species = The coefficient of the temperature dependence of the half width</span>

<span class="sd">            delta_0_species = The pressure shift (cm−1/atm) at Tref=296K and pref=1atm of the line position with respect to the vacuum transition wavenumber νij</span>

<span class="sd">            n_delta0_species = the coefficient of the temperature dependence of the pressure shift</span>

<span class="sd">            SD_gamma_species = the ratio of the speed dependent width to the half-width at reference temperature and pressure</span>

<span class="sd">            n_gamma2_species = the coefficient of the temperature dependence of the speed dependent width NOTE: This is the temperature dependence of the speed dependent width not the ratio of the speed dependence to the half-width</span>

<span class="sd">            SD_delta_species = the ratio of the speed dependent shift to the collisional shift at reference temperature and pressure</span>

<span class="sd">            n_delta2_species = the coefficient of the temperature dependence of the speed dependent shift NOTE: This is the temperature dependence of the speed dependent shift not the ratio of the speed dependence to the shift</span>

<span class="sd">            nuVC_species = dicke narrowing term at reference temperature</span>

<span class="sd">            n_nuVC_species = coefficient of the temperature dependence of the dicke narrowing term</span>

<span class="sd">            eta_species = the correlation parameter for the VC and SD effects</span>

<span class="sd">            y_species = linemixing term </span>
<span class="sd">            </span>
<span class="sd">            n_y_species = temperature dependence of line mixing term</span>
<span class="sd">    waves : array</span>
<span class="sd">        1-D array comprised of wavenumbers (cm-1) to use as x-axis for simulation.</span>
<span class="sd">    wing_cutoff : float, optional</span>
<span class="sd">        number of half-widths for each line to be calculated for. The default is 50.</span>
<span class="sd">    wing_wavenumbers : float, optional</span>
<span class="sd">        number of wavenumber for each line to be calculated. The default is 50.</span>
<span class="sd">    wing_method : str, optional</span>
<span class="sd">        defines which wing cut-off option to use.  Options are wing_cutoff or wing_wavenumbers The default is &#39;wing_cutoff&#39;.</span>
<span class="sd">    p : float, optional</span>
<span class="sd">        pressure for simulation in atmospheres. The default is 1.</span>
<span class="sd">    T : float, optional</span>
<span class="sd">        temperature for simulation in kelvin. The default is 296.</span>
<span class="sd">    molefraction : dict, optional</span>
<span class="sd">        takes the form {molecule_id : mole fraction, molecule_id: mole fraction, . . .}. The default is {}.</span>
<span class="sd">    isotope_list : dict, optional</span>
<span class="sd">        provides opportunity to specify the isotope look-up table.  Default is ISO, which is from HAPI.  If not using ISO, then must use this format and suggested you use function to add to ISO</span>
<span class="sd">    natural_abundance : bool, optional</span>
<span class="sd">        True indicates the sample is at natural abundance. The default is True.</span>
<span class="sd">    abundance_ratio_MI : dictionary, optional</span>
<span class="sd">        If sample is not at natural abundance, then the natural abundance defines the enrichment factor compared to natural abundance(ie a sample where the main isotope is the only isotope would have a 1/natural abundance as the enrichment factor). Defined as {M:{I:enrichment factor, I: enrichment factor, I: enrichment factor}, . . . }. The default is {}.</span>
<span class="sd">    Diluent : dict, optional</span>
<span class="sd">        contains the species as the key with the value being the abundance of that diluent in the sample, ie {&#39;He&#39;:0.5, &#39;self&#39;:0.5}. The default is {}.</span>
<span class="sd">    diluent : str, optional</span>
<span class="sd">        If Diluent = {}, then this value will be used to set the only diluent to be equal to this diluent. The default is &#39;air&#39;.</span>
<span class="sd">    IntensityThreshold : float, optional</span>
<span class="sd">        minimum line intensity that will be simulated. The default is 1e-30.</span>
<span class="sd">    TIPS : definition, optional</span>
<span class="sd">        selects the HAPI provided TIPS version to use for the partition function</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavenumbers : array</span>
<span class="sd">        wavenumber axis that should match the input waves</span>
<span class="sd">    xsect : array</span>
<span class="sd">        simulated cross section as a function of wavenumbers (ppm/cm)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Generate X-axis for simulation</span>
    <span class="n">wavenumbers</span> <span class="o">=</span> <span class="n">waves</span>

    <span class="c1">#Set Omegas to X-values</span>
    <span class="n">Xsect</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">)</span>

    <span class="c1">#define reference temperature/pressure and calculate molecular density</span>
    <span class="n">Tref</span> <span class="o">=</span> <span class="mf">296.</span> <span class="c1"># K</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># atm</span>
    <span class="n">mol_dens</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;cpa_atm&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">T</span><span class="p">)</span>
    <span class="n">mol_dens</span> <span class="o">=</span> <span class="n">mol_dens</span> <span class="o">/</span> <span class="n">compressability_factor</span>

    <span class="c1">#Sets-up the  Diluent (currently limited to air or self, unless manual input in Diluent)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Diluent</span><span class="p">:</span>
         <span class="c1">#Diluent = {diluent:1.}</span>
         <span class="k">if</span> <span class="n">diluent</span> <span class="o">==</span> <span class="s1">&#39;air&#39;</span><span class="p">:</span>
             <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{</span><span class="n">diluent</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="mf">28.95734</span><span class="p">}}</span>
         <span class="k">elif</span> <span class="n">diluent</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
            <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{</span><span class="n">diluent</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span>
         <span class="k">else</span><span class="p">:</span>
            <span class="n">Diluent</span> <span class="o">=</span> <span class="p">{</span><span class="n">diluent</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;composition&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span>
            <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;THIS IS GOING TO BREAK WITH A DIVISION ERROR.  GO BACK AND USE DILUENT FORMALISM FOR THE SPECTRUM DEFINITION&#39;</span><span class="p">)</span>



    <span class="c1">#Calculate line intensity</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;abun_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">molec</span> <span class="ow">in</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">linelist</span> <span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIPS</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span><span class="n">T</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIPS</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span><span class="n">Tref</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>


            <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molecularMass</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="n">isotope_list</span><span class="p">)</span> <span class="c1">#* 1.66053873e-27 * 1000 #cmassmol and kg conversion</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Diluent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;self&#39;</span> <span class="ow">in</span> <span class="n">Diluent</span><span class="p">):</span>
                <span class="n">Diluent</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">][</span><span class="s1">&#39;mp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molecularMass</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="n">isotope_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">natural_abundance</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">abundance_ratio_MI</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;abun_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abundance_ratio_MI</span><span class="p">[</span><span class="n">molec</span><span class="p">][</span><span class="n">iso</span><span class="p">]</span>
    <span class="c1"># Calculate mp</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">diluent</span> <span class="ow">in</span> <span class="n">Diluent</span><span class="p">:</span>
        <span class="n">mp</span> <span class="o">+=</span> <span class="n">Diluent</span><span class="p">[</span><span class="n">diluent</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">Diluent</span><span class="p">[</span><span class="n">diluent</span><span class="p">][</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>

    <span class="c1"># Get Line Intensity</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;elower&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">T</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;elower&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Tref</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Tref</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">isotope_list</span> <span class="o">!=</span> <span class="n">ISO</span><span class="p">:</span>
        <span class="n">linelist</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaT&#39;</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SigmaTref&#39;</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])][</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1">#Calculate Doppler Broadening</span>
    <span class="c1">#linelist[&#39;GammaD&#39;] = np.sqrt(2*1.380648813E-16*T*np.log(2)/linelist[&#39;m&#39;]/2.99792458e10**2)*linelist[&#39;nu&#39;]</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>

    <span class="c1"># Calculated Line Parameters across Broadeners</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">Diluent</span><span class="p">:</span>
        <span class="n">abun</span> <span class="o">=</span> <span class="n">Diluent</span><span class="p">[</span><span class="n">species</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>
        <span class="c1">#Gamma0: pressure broadening coefficient HWHM</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;gamma0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_gamma0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]))</span>
        <span class="c1">#Delta0</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift0&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">((</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;delta0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_delta0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">Tref</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span>
        <span class="c1">#Gamma2</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma2&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SD_gamma_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;gamma0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_gamma2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]))</span>
        <span class="c1">#Delta2</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Shift2&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">((</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;SD_delta_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;delta0_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_delta2_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">Tref</span><span class="p">))</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span>
        <span class="c1">#nuVC</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">])))</span>
        <span class="c1">#eta</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;eta_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span> <span class="o">*</span><span class="n">abun</span>
        <span class="c1">#Line mixing</span>
        <span class="c1">#linelist[&#39;Y&#39;] += abun*(linelist[&#39;y_%s&#39;%species]*(p/pref))</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;y_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">pref</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">Tref</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;n_y_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">species</span><span class="p">])))</span>

    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mp</span> <span class="o">/</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Chi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0534</span> <span class="o">+</span> <span class="mf">0.1585</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.451</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.9595</span> <span class="o">-</span> <span class="mf">0.1258</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mf">0.0056</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.0050</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0546</span> <span class="o">+</span> <span class="mf">0.0672</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mf">0.0125</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.0003</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9466</span> <span class="o">-</span> <span class="mf">0.1585</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4510</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Chi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>


    <span class="c1">#Line profile simulation cut-off determination</span>
    <span class="k">if</span> <span class="n">wing_method</span> <span class="o">==</span> <span class="s1">&#39;wing_cutoff&#39;</span><span class="p">:</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5346</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.2166</span><span class="o">*</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">wing_cutoff</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wing_wavenumbers</span>

    <span class="c1">#Enforce  Line Intensity Simulation Threshold</span>
    <span class="n">linelist</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span><span class="o">&gt;=</span> <span class="n">IntensityThreshold</span><span class="p">]</span>

    <span class="c1">#For each line calculate spectrum and add to the global spectrum</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">linelist</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">BoundIndexLower</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">])</span>
        <span class="n">BoundIndexUpper</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;line cut-off&#39;</span><span class="p">])</span>
        <span class="n">lineshape_vals_real</span><span class="p">,</span> <span class="n">lineshape_vals_imag</span> <span class="o">=</span> <span class="n">pcqsdhc</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;GammaD&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Gamma0&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Gamma2&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Shift0&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Shift2&#39;</span><span class="p">],</span>
                                                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;NuVC&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">],</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;Eta&#39;</span><span class="p">],</span><span class="n">wavenumbers</span><span class="p">[</span><span class="n">BoundIndexLower</span><span class="p">:</span><span class="n">BoundIndexUpper</span><span class="p">])</span>
        <span class="n">Xsect</span><span class="p">[</span><span class="n">BoundIndexLower</span><span class="p">:</span><span class="n">BoundIndexUpper</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mol_dens</span>  <span class="o">*</span> \
                                                    <span class="n">molefraction</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;abun_ratio&#39;</span><span class="p">]</span> <span class="o">*</span> \
                                                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;LineIntensity&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">lineshape_vals_real</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">lineshape_vals_imag</span><span class="p">)</span>

    <span class="c1"># Return two arrays corresponding to the wavenumber axis and the calculated cross-section</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Xsect</span><span class="p">))</span></div>

<div class="viewcode-block" id="Fit_DataSet"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet">[docs]</a><span class="k">class</span> <span class="nc">Fit_DataSet</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides the fitting functionality for a Dataset.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataset : object</span>
<span class="sd">        Dataset Object.</span>
<span class="sd">    base_linelist_file : str</span>
<span class="sd">        filename for file containing baseline parameters.</span>
<span class="sd">    param_linelist_file : str</span>
<span class="sd">        filename for file containing parmeter parameters.</span>
<span class="sd">    CIA_linelist_file : str, optional</span>
<span class="sd">        Future Feature: filename for file constraining CIA parameters</span>
<span class="sd">    minimum_parameter_fit_intensity : float, optional</span>
<span class="sd">        minimum intensity for parameters to be generated for fitting. NOTE: Even if a value is floated in the param_linelist if it is below this threshold then it won&#39;t be a floated.. The default is 1e-27.</span>
<span class="sd">    weight_spectra : boolean</span>
<span class="sd">        If True, then the pt by pt percent uncertainty for each spectrum and the spectrum weighting will be used in the calculation of the residuals.  Default is False.</span>
<span class="sd">    baseline_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on baseline parameter solutions. The default is False.</span>
<span class="sd">    baseline_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor that the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    pressure_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on pressure solutions. The default is False.</span>
<span class="sd">    pressure_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    temperature_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on temperature solutions. The default is False.</span>
<span class="sd">    temperature_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    molefraction_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on mole fraction solutions. The default is False.</span>
<span class="sd">    molefraction_limit_factor : float, optional</span>
<span class="sd">        DESCRIPTION. The default is 10.</span>
<span class="sd">    etalon_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on etalon solutions. The default is False.</span>
<span class="sd">    etalon_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 50. #phase is constrained to +/- 2pi</span>
<span class="sd">    x_shift_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on x-shift solutions. The default is False.</span>
<span class="sd">    x_shift_limit_magnitude : float, optional</span>
<span class="sd">        The magnitude variables set the +/- range of the variable in cm-1. The default is 0.1.</span>
<span class="sd">    nu_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on line center solutions. The default is False.</span>
<span class="sd">    nu_limit_magnitude : float, optional</span>
<span class="sd">        The magnitude variables set the +/- range of the variable in cm-1. The default is 0.1.</span>
<span class="sd">    sw_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on line intensity solutions. The default is False.</span>
<span class="sd">    sw_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    gamma0_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on collisional half-width solutions. The default is False.</span>
<span class="sd">    gamma0_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    n_gamma0_limit : bool, optional</span>
<span class="sd">        DESCIf True, then impose min/max limits on temperature exponent for half width solutions. The default is True.</span>
<span class="sd">    n_gamma0_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    delta0_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on collisional shift solutions. The default is False.</span>
<span class="sd">    delta0_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    n_delta0_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on temperature exponent of the collisional shift solutions. The default is True.</span>
<span class="sd">    n_delta0_limit_factor : float, optional</span>
<span class="sd">        DESCRIPTION. The default is 10.</span>
<span class="sd">    SD_gamma_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on the aw solutions. The default is False.</span>
<span class="sd">    SD_gamma_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    n_gamma2_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on temperature exponent of the speed-dependent width solutions. The default is True.</span>
<span class="sd">    n_gamma2_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    SD_delta_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on as solutions. The default is True.</span>
<span class="sd">    SD_delta_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    n_delta2_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on temperature exponent of the speed-dependent shift solutions. The default is True.</span>
<span class="sd">    n_delta2_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    nuVC_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on dicke narrowing solutions. The default is False.</span>
<span class="sd">    nuVC_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    n_nuVC_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on temperature exponent of dicke narrowing solutions. The default is True.</span>
<span class="sd">    n_nuVC_limit_factor : float, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is 10.</span>
<span class="sd">    eta_limit : bool, optional</span>
<span class="sd">        If True, then impose min/max limits on correlation parameter solutions.. The default is True.</span>
<span class="sd">    eta_limit_factor : float, optional</span>
<span class="sd">         The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.The default is 10.</span>
<span class="sd">    linemixing_limit : bool, optional</span>
<span class="sd">        The factor variable describes the multiplicative factor the value can vary by min = 1/factor * init_guess, max = factor* init_guess. NOTE: If the init_guess for a parameter is equal to zero, then the limits aren&#39;t imposed because 1) then it would constrain the fit to 0 and 2) LMfit won&#39;t let you set min = max.. The default is False.</span>
<span class="sd">    linemixing_limit_factor : float, optional</span>
<span class="sd">        If True, then impose min/max limits on line-mixing solutions.. The default is 10.</span>
<span class="sd">    beta_formalism : boolean, optional</span>
<span class="sd">        If True, then the beta correction on the Dicke narrowing is used in the simulation model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">base_linelist_file</span><span class="p">,</span> <span class="n">param_linelist_file</span><span class="p">,</span> <span class="n">CIA_linelist_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">minimum_parameter_fit_intensity</span> <span class="o">=</span> <span class="mf">1e-27</span><span class="p">,</span> <span class="n">weight_spectra</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">baseline_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">baseline_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">pressure_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">pressure_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">temperature_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">temperature_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">molefraction_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">molefraction_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">etalon_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">etalon_limit_factor</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="c1">#phase is constrained to +/- 2pi,</span>
                <span class="n">x_shift_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">x_shift_limit_magnitude</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="n">nu_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nu_limit_magnitude</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="n">sw_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">sw_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">gamma0_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">gamma0_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_gamma0_limit</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_gamma0_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">delta0_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">delta0_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_delta0_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_delta0_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">SD_gamma_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">SD_gamma_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_gamma2_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_gamma2_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">SD_delta_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">SD_delta_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_delta2_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_delta2_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">nuVC_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nuVC_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_nuVC_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_nuVC_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">eta_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">eta_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">linemixing_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">linemixing_limit_factor</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">n_linemixing_limit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_linemixing_limit_factor</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                <span class="n">beta_formalism</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_linelist_file</span> <span class="o">=</span> <span class="n">base_linelist_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_linelist_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span><span class="c1">#, index_col = 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_linelist_file</span> <span class="o">=</span> <span class="n">param_linelist_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_linelist_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CIA_linelist_file</span> <span class="o">=</span> <span class="n">CIA_linelist_file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIA_linelist_file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIA_linelist_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_parameter_fit_intensity</span> <span class="o">=</span> <span class="n">minimum_parameter_fit_intensity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_spectra</span> <span class="o">=</span> <span class="n">weight_spectra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_limit</span> <span class="o">=</span> <span class="n">baseline_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_limit_factor</span>  <span class="o">=</span> <span class="n">baseline_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure_limit</span> <span class="o">=</span> <span class="n">pressure_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pressure_limit_factor</span> <span class="o">=</span> <span class="n">pressure_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature_limit</span> <span class="o">=</span> <span class="n">temperature_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature_limit_factor</span> <span class="o">=</span> <span class="n">temperature_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit</span> <span class="o">=</span> <span class="n">etalon_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit_factor</span> <span class="o">=</span> <span class="n">etalon_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molefraction_limit</span> <span class="o">=</span> <span class="n">molefraction_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molefraction_limit_factor</span> <span class="o">=</span> <span class="n">molefraction_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit</span> <span class="o">=</span> <span class="n">etalon_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit_factor</span> <span class="o">=</span> <span class="n">etalon_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_shift_limit</span> <span class="o">=</span> <span class="n">x_shift_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_shift_limit_magnitude</span> <span class="o">=</span> <span class="n">x_shift_limit_magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit</span> <span class="o">=</span> <span class="n">nu_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit_magnitude</span> <span class="o">=</span> <span class="n">nu_limit_magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit</span> <span class="o">=</span> <span class="n">sw_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit_factor</span> <span class="o">=</span> <span class="n">sw_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit</span> <span class="o">=</span> <span class="n">gamma0_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit_factor</span> <span class="o">=</span> <span class="n">gamma0_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma0_limit</span> <span class="o">=</span> <span class="n">n_gamma0_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma0_limit_factor</span> <span class="o">=</span> <span class="n">n_gamma0_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit</span> <span class="o">=</span> <span class="n">delta0_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit_factor</span><span class="o">=</span> <span class="n">delta0_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_delta0_limit</span> <span class="o">=</span> <span class="n">n_delta0_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_delta0_limit_factor</span> <span class="o">=</span> <span class="n">n_delta0_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit</span> <span class="o">=</span> <span class="n">SD_gamma_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit_factor</span> <span class="o">=</span> <span class="n">SD_gamma_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma2_limit</span> <span class="o">=</span> <span class="n">n_gamma2_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma2_limit_factor</span> <span class="o">=</span> <span class="n">n_gamma2_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit</span> <span class="o">=</span> <span class="n">SD_gamma_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit_factor</span> <span class="o">=</span> <span class="n">SD_delta_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_delta2_limit</span> <span class="o">=</span> <span class="n">n_delta2_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_delta2_limit_factor</span> <span class="o">=</span> <span class="n">n_delta2_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit</span> <span class="o">=</span> <span class="n">nuVC_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit_factor</span> <span class="o">=</span> <span class="n">nuVC_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_nuVC_limit</span> <span class="o">=</span> <span class="n">n_nuVC_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_nuVC_limit_factor</span> <span class="o">=</span> <span class="n">n_nuVC_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit</span> <span class="o">=</span> <span class="n">eta_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit_factor</span> <span class="o">=</span> <span class="n">eta_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit</span> <span class="o">=</span> <span class="n">linemixing_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit_factor</span> <span class="o">=</span> <span class="n">linemixing_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_linemixing_limit</span> <span class="o">=</span> <span class="n">n_linemixing_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_linemixing_limit_factor</span> <span class="o">=</span> <span class="n">n_linemixing_limit_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta_formalism</span> <span class="o">=</span> <span class="n">beta_formalism</span>


<div class="viewcode-block" id="Fit_DataSet.generate_params"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.generate_params">[docs]</a>    <span class="k">def</span> <span class="nf">generate_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates the lmfit parameter object that will be used in fitting.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the parameter object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">Parameters</span><span class="p">()</span>
        <span class="c1">#Baseline Parameters</span>
        <span class="n">baseline_parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">base_param</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Spectrum Number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;Segment Number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">):</span>
                <span class="n">baseline_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_param</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">spec_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span>
            <span class="n">seg_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">base_param</span> <span class="ow">in</span> <span class="n">baseline_parameters</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;Pressure&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_limit</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span>
                              <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pressure_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;Temperature&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_limit</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span>
                              <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;molefraction&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">molefraction_limit</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">molefraction_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span>
                              <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molefraction_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;baseline&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_limit</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span>
                              <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_limit_factor</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;etalon_&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;phase&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">):</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit_factor</span> <span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span>
                              <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit_factor</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;etalon_&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">etalon_limit</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;phase&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">):</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;x_shift&#39;</span> <span class="ow">in</span> <span class="n">base_param</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_shift_limit</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                              <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_shift_limit_magnitude</span><span class="p">),</span>
                              <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_shift_limit_magnitude</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_num</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seg_num</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">base_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                
        <span class="c1">#Lineshape parameters</span>
        <span class="n">linelist_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line_param</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_number_nominal_temperatures</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;molec_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;local_iso_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;elower&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>
                    <span class="n">linelist_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;molec_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;local_iso_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;elower&#39;</span><span class="p">):</span>
                    <span class="n">linelist_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_param</span><span class="p">)</span>
        <span class="n">diluent_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">diluent</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">diluent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diluent_list</span><span class="p">:</span>
                    <span class="n">diluent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diluent</span><span class="p">)</span>
        <span class="n">nu_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">sw_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">gamma0_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">delta0_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">SD_gamma_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">SD_delta_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">eta_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">linemix_constrain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">sum</span><span class="p">((</span><span class="s1">&#39;nu&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nu_constrain</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;sw&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sw_constrain</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_number_nominal_temperatures</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;gamma0&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">gamma0_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;delta0&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">delta0_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;SD_gamma&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">SD_gamma_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;SD_delta&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">SD_delta_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">eta_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">linemix_constrain</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;gamma0&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">gamma0_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;delta0&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">delta0_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;SD_gamma&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">SD_gamma_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;SD_delta&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">SD_delta_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">eta_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">))</span> <span class="o">&gt;</span>  <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                <span class="n">eta_constrain</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="k">for</span> <span class="n">spec_line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_parameter_fit_intensity</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="s1">&#39;sw_scale_factor&#39;</span><span class="p">]:</span><span class="c1"># bigger than 1 because fit_intensity / fit_intensity</span>
                <span class="k">for</span> <span class="n">line_param</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">line_param</span><span class="p">)]</span>
                    <span class="n">index_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="c1">#NU</span>
                    <span class="k">if</span> <span class="n">line_param</span> <span class="o">==</span> <span class="s1">&#39;nu&#39;</span> <span class="ow">and</span> <span class="n">nu_constrain</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                      <span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit_magnitude</span><span class="p">,</span>
                                      <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit_magnitude</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;nu&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;nu&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">nu_constrain</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                      <span class="nb">min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit_magnitude</span><span class="p">,</span>
                                      <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu_limit_magnitude</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#SW</span>
                    <span class="k">elif</span> <span class="n">line_param</span> <span class="o">==</span> <span class="s1">&#39;sw&#39;</span> <span class="ow">and</span> <span class="n">sw_constrain</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit_factor</span><span class="p">)</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit_factor</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;sw&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;sw&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sw_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">line_param</span> <span class="o">!=</span> <span class="s1">&#39;sw_scale_factor&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit_factor</span><span class="p">)</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sw_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#GAMMA0</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;gamma0_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gamma0_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">]</span> <span class="p">,</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;gamma0_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">gamma0_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma0_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;n_gamma0&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma0_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma0_limit_factor</span><span class="p">)</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma0_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#DELTA0</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;delta0&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">delta0_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit_factor</span> <span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;delta0_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">delta0_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta0_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;n_delta0&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delta0_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delta0_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delta0_limit_factor</span> <span class="o">/</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#SD Gamma</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;SD_gamma&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">SD_gamma_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit_factor</span><span class="p">)</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;SD_gamma&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">SD_gamma_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_gamma_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;n_gamma2&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma2_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_gamma2_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                <span class="nb">max</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_gamma2_limit_factor</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#SD Delta</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;SD_delta&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">SD_delta_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit_factor</span> <span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;SD_delta&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">SD_delta_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit_factor</span> <span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SD_delta_limit_factor</span> <span class="o">/</span> <span class="mi">100</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;n_delta2&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delta2_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delta2_limit_factor</span> <span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delta2_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#nuVC</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_nuVC_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nuVC_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_formalism</span><span class="p">:</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span> <span class="nb">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">nuVC_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nuVC_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_formalism</span><span class="p">:</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span> <span class="nb">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;n_nuVC&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_nuVC_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_nuVC_limit_factor</span> <span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_nuVC_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1">#eta</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;eta_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">eta_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;eta_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">eta_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="c1"># linemixing</span>
                    
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;y_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">linemix_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">]</span> <span class="p">,</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;y_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;n_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">linemix_constrain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">index_length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit_factor</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linemixing_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                             <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;n_y_&#39;</span> <span class="ow">in</span> <span class="n">line_param</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_linemixing_limit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">],</span>
                                  <span class="nb">min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_linemixing_limit_factor</span><span class="p">)</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">],</span>
                                  <span class="nb">max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_linemixing_limit_factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec_line</span><span class="p">)][</span><span class="n">line_param</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39;line_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spec_line</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spec_line</span><span class="p">][</span><span class="n">line_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
        
        <span class="c1">#CIA Parameters (O2 Karman Model)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Karman&quot;</span><span class="p">:</span>
            <span class="n">cia_parameters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cia_param</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cia_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cia_param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;CIA Pair&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cia_param</span><span class="p">):</span>
                    <span class="n">cia_parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cia_param</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cia_pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="s1">&#39;CIA Pair&#39;</span><span class="p">]:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="s1">&#39;CIA Pair&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">cia_pair</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   
                <span class="k">for</span> <span class="n">cia_param</span> <span class="ow">in</span> <span class="n">cia_parameters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;SO&#39;</span> <span class="ow">in</span> <span class="n">cia_param</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cia_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">cia_pair</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">cia_param</span><span class="p">],</span> 
                                   <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">cia_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="s1">&#39;EXCH&#39;</span> <span class="ow">in</span> <span class="n">cia_param</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cia_pair</span> <span class="o">==</span> <span class="s1">&#39;O2_O2&#39;</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cia_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">cia_pair</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">cia_param</span><span class="p">],</span> 
                                   <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">cia_param</span> <span class="o">+</span> <span class="s1">&#39;_vary&#39;</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">cia_pair</span> <span class="o">==</span><span class="s1">&#39;O2_N2&#39;</span><span class="p">:</span>
                            <span class="n">params</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cia_param</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">cia_pair</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="Fit_DataSet.constrained_baseline"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.constrained_baseline">[docs]</a>    <span class="k">def</span> <span class="nf">constrained_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">baseline_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">xshift_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">molefraction_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">etalon_amp_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">etalon_period_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">etalon_phase_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="n">pressure_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">temperature_segment_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Imposes baseline constraints when using multiple segments per spectrum, ie all baseline parameters can be the same across the entire spectrum except for the etalon phase, which is allowed to vary per segment.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the params object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit.</span>
<span class="sd">        baseline_segment_constrained : bool, optional</span>
<span class="sd">            True means the baseline terms are constrained across each spectrum. The default is True.</span>
<span class="sd">        xshift_segment_constrained : bool, optional</span>
<span class="sd">            True means the x_shift terms are constrained across each spectrum. The default is True.</span>
<span class="sd">        molefraction_segment_constrained : bool, optional</span>
<span class="sd">            True means the mole fraction for that molecule is constrained across each spectrum. The default is True.</span>
<span class="sd">        etalon_amp_segment_constrained : bool, optional</span>
<span class="sd">            True means the etalon amplitude is constrained across each spectrum. The default is True.</span>
<span class="sd">        etalon_period_segment_constrained : bool, optional</span>
<span class="sd">            True means the etalon period is constrained across each spectrum. The default is True.</span>
<span class="sd">        etalon_phase_segment_constrained : bool, optional</span>
<span class="sd">            True means the etalon phase is constrained across each spectrum. The default is True.</span>
<span class="sd">        pressure_segment_constrained : bool, optional</span>
<span class="sd">            True means the pressure is constrained across each spectrum. The default is True.</span>
<span class="sd">        temperature_segment_constrained : bool, optional</span>
<span class="sd">            True means the temperature is constrained across each spectrum. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the params object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spectrum_segment_min</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">segments</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Pressure&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pressure_segment_constrained</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;Temperature&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">temperature_segment_constrained</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>

            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;baseline&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">baseline_segment_constrained</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">segment_num</span> <span class="o">!=</span> <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;x_shift&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xshift_segment_constrained</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">segment_num</span> <span class="o">!=</span> <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;molefraction&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">molefraction_segment_constrained</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">segment_num</span> <span class="o">!=</span> <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]:</span>
                    <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;etalon&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
                <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">if</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="ow">and</span> <span class="n">etalon_amp_segment_constrained</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">segment_num</span> <span class="o">!=</span> <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="s1">&#39;period&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="ow">and</span> <span class="n">etalon_period_segment_constrained</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">segment_num</span> <span class="o">!=</span> <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="s1">&#39;phase&#39;</span> <span class="ow">in</span> <span class="n">param</span> <span class="ow">and</span> <span class="n">etalon_phase_segment_constrained</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">segment_num</span> <span class="o">!=</span> <span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_segment_min</span><span class="p">[</span><span class="n">spectrum_num</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">params</span></div>
    
<div class="viewcode-block" id="Fit_DataSet.constrained_CIA"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.constrained_CIA">[docs]</a>    <span class="k">def</span> <span class="nf">constrained_CIA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">S_temperature_dependence_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">shift_constrained</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;All user to set the temperature dependence of the SO mechanism scalar and/or the shift of the SO to be equal for O2-O2 and O2_N2</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the params object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit.</span>
<span class="sd">        S_temperature_dependence_constrained : boolean, optional</span>
<span class="sd">            Constrains the temperature dependence of the SO mechanism scalar to be the same for O2-N2 and O2-O2. The default is True.</span>
<span class="sd">        shift_constrained : boolean, optional</span>
<span class="sd">            Constrains the SO shift to be the same for O2-N2 and O2-O2. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the params object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Karman&#39;</span><span class="p">:</span>
        
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;SO_b&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;SO_c&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">))</span> <span class="ow">and</span> <span class="n">S_temperature_dependence_constrained</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;O2_O2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;O2_O2&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;SO_shift&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shift_constrained</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;O2_O2&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">expr</span> <span class="o">=</span> <span class="n">param</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;O2_O2&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span></div>
    
<div class="viewcode-block" id="Fit_DataSet.simulation_model"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.simulation_model">[docs]</a>    <span class="k">def</span> <span class="nf">simulation_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">wing_cutoff</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_wavenumbers</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_method</span> <span class="o">=</span> <span class="s1">&#39;wing_cutoff&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is the model used for fitting that includes baseline, resonant absorption, and CIA models.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the params object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit.</span>
<span class="sd">        wing_cutoff : float, optional</span>
<span class="sd">            number of voigt half-widths to simulate on either side of each line. The default is 25.</span>
<span class="sd">        wing_wavenumbers : float, optional</span>
<span class="sd">            number of wavenumbers to simulate on either side of each line. The default is 25</span>
<span class="sd">        wing_method : TYPE, optional</span>
<span class="sd">            Provides choice between the wing_cutoff and wing_wavenumbers line cut-off options. The default is &#39;wing_cutoff&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        total_residuals : array</span>
<span class="sd">            residuals for all spectra in Dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">total_simulated</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_residuals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">baseline_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">linelist_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Karman_CIA_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;S_SO_O2_O2&#39;</span><span class="p">,</span> <span class="s1">&#39;S_SO_O2_N2&#39;</span><span class="p">,</span> <span class="s1">&#39;S_EXCH_O2_O2&#39;</span><span class="p">,</span> <span class="s1">&#39;EXCH_b_O2_O2&#39;</span><span class="p">,</span> <span class="s1">&#39;EXCH_c_O2_O2&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;SO_b_O2_O2&#39;</span><span class="p">,</span> <span class="s1">&#39;SO_c_O2_O2&#39;</span><span class="p">,</span> <span class="s1">&#39;SO_b_O2_N2&#39;</span><span class="p">,</span> <span class="s1">&#39;SO_c_O2_N2&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;SO_shift_O2_O2&#39;</span><span class="p">,</span> <span class="s1">&#39;SO_shift_O2_N2&#39;</span><span class="p">,</span><span class="s1">&#39;EXCH_shift_O2_O2&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;EXCH_shift_O2_N2&#39;</span><span class="p">,</span> <span class="s1">&#39;S_EXCH_O2_N2&#39;</span><span class="p">,</span> <span class="s1">&#39;EXCH_b_O2_N2&#39;</span><span class="p">,</span> <span class="s1">&#39;EXCH_c_O2_N2&#39;</span><span class="p">]</span> <span class="c1">#this row has unused parameters</span>

        <span class="c1"># Set-up Baseline Parameters</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">valuesdict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;molefraction&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;baseline&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;etalon&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;x_shift&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Pressure&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Temperature&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;_res_&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                <span class="n">baseline_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">==</span> <span class="s1">&#39;Karman&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span> <span class="ow">in</span> <span class="n">Karman_CIA_params</span><span class="p">):</span>
                <span class="c1">#print (param)</span>
                <span class="mi">1</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linelist_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="n">simulated_spectra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">residuals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wavenumber_segments</span><span class="p">,</span> <span class="n">alpha_segments</span><span class="p">,</span> <span class="n">indices_segments</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">segment_wave_alpha</span><span class="p">()</span>
            <span class="n">Diluent</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span>
            <span class="n">spectrum_number</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span>
            <span class="c1">#nominal_temp = spectrum.nominal_temperature</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">,</span> <span class="s1">&#39;local_iso_id&#39;</span><span class="p">,</span> <span class="s1">&#39;elower&#39;</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">,</span> <span class="s1">&#39;sw&#39;</span><span class="p">,</span> <span class="s1">&#39;sw_scale_factor&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">Diluent</span><span class="p">:</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gamma0_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;n_gamma0_&#39;</span><span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;delta0_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;n_delta0_&#39;</span><span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SD_gamma_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;n_gamma2_&#39;</span><span class="o">+</span> <span class="n">species</span> <span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SD_delta_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;n_delta2_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nuVC_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;n_nuVC_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;eta_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;y_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;n_y_&#39;</span> <span class="o">+</span> <span class="n">species</span><span class="p">)</span>
            <span class="n">rename_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="p">):</span>
                        <span class="n">columns</span> <span class="o">=</span> <span class="p">[(</span><span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">))</span><span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="n">column</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
                        <span class="n">rename_dictionary</span><span class="p">[(</span><span class="n">column</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>  <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">))]</span> <span class="o">=</span> <span class="n">column</span>
            <span class="n">linelist_for_sim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Replaces the relevant linelist locations with the</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">linelist_params</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="n">parameter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_line_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">:])</span>
                <span class="n">param</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[:</span><span class="n">parameter</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_line_&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;sw&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                        <span class="c1">#print (linelist_for_sim[line][&#39;sw_scale_factor&#39;])</span>
                        <span class="n">linelist_for_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">parameter</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">linelist_for_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">parameter</span><span class="p">])</span>
            <span class="c1">#Renames columns to generic (no scan number)</span>
            <span class="n">linelist_for_sim</span><span class="o">=</span><span class="n">linelist_for_sim</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">rename_dictionary</span><span class="p">)</span>
            <span class="n">linelist_for_sim</span><span class="p">[</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist_for_sim</span><span class="p">[</span><span class="s1">&#39;sw&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">linelist_for_sim</span><span class="p">[</span><span class="s1">&#39;sw_scale_factor&#39;</span><span class="p">]</span>
            
            <span class="c1">#Calculate CIA for Spectrum</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Karman&quot;</span><span class="p">:</span>
                <span class="n">CIA</span> <span class="o">=</span> <span class="n">o2_cia_karman_model</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_temperature</span><span class="p">(),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_pressure</span><span class="p">(),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_Diluent</span><span class="p">(),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_SO_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_SO_O2_N2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_EXCH_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;EXCH_b_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;EXCH_c_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_b_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_c_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_b_O2_N2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_c_O2_N2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_shift_O2_O2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_shift_O2_N2&#39;</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;EXCH_shift_O2_N2&#39;</span><span class="p">]),</span>
                        <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span>
                <span class="n">spectrum</span><span class="o">.</span><span class="n">set_cia</span><span class="p">(</span><span class="n">CIA</span><span class="p">)</span>  
            <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">compressability_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">comp_factor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compressability_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
                <span class="n">pressures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">comp_factor</span><span class="p">[</span><span class="s1">&#39;Pressure (MPa)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">*</span><span class="mf">1e6</span><span class="o">/</span><span class="mi">101325</span><span class="p">)</span>
                <span class="n">pressures</span> <span class="o">=</span> <span class="n">pressures</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">comp_factor</span><span class="p">)</span>
                <span class="n">temperatures</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Pressure (MPa)&#39;</span><span class="p">)</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
                <span class="n">temperatures</span> <span class="o">=</span> <span class="n">temperatures</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">comp_factor</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Pressure (MPa)&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
                <span class="n">comp_factor_array</span> <span class="o">=</span> <span class="n">comp_factor</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">interp_comp_factor</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">(</span><span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">pressures</span><span class="p">,</span> <span class="n">temperatures</span><span class="p">],</span> <span class="n">values</span> <span class="o">=</span> <span class="n">comp_factor_array</span><span class="p">)</span>
                                
            
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">segments</span><span class="p">)):</span>
                <span class="n">wavenumbers</span> <span class="o">=</span> <span class="n">wavenumber_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span>
                <span class="n">wavenumbers_relative</span> <span class="o">=</span> <span class="n">wavenumbers</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)</span>
                <span class="n">x_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x_shift_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)])</span>
                <span class="c1">#linelist_for_sim[&#39;nu&#39;] = linelist_for_sim[&#39;nu&#39;] + x_shift # Q</span>
                <span class="n">wavenumbers</span> <span class="o">+=</span> <span class="n">x_shift</span>
                <span class="n">wavenumbers_relative</span><span class="o">+=</span> <span class="n">x_shift</span>
                <span class="c1">#Set-up MoleFraction for Fitting</span>
                <span class="n">fit_molefraction</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">molefraction</span>
                <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">molefraction</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;molefraction_&#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isotope_list</span><span class="p">[(</span><span class="n">molecule</span><span class="p">,</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="ow">in</span> <span class="n">baseline_params</span><span class="p">:</span>
                        <span class="n">fit_molefraction</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[(</span><span class="s1">&#39;molefraction_&#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isotope_list</span><span class="p">[(</span><span class="n">molecule</span><span class="p">,</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">4</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)])</span>
                <span class="c1">#Get Environmental Parameters</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Pressure_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)])</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;Temperature_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">compressability_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">compressability_factor</span> <span class="o">=</span> <span class="n">interp_comp_factor</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compressability_factor</span> <span class="o">=</span> <span class="mi">1</span>    
                
                <span class="c1">#Simulate Spectra</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_formalism</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">fit_nu</span><span class="p">,</span> <span class="n">fit_coef</span> <span class="o">=</span> <span class="n">HTP_wBeta_from_DF_select</span><span class="p">(</span><span class="n">linelist_for_sim</span><span class="p">,</span> <span class="n">wavenumbers</span><span class="p">,</span> <span class="n">wing_cutoff</span> <span class="o">=</span> <span class="n">wing_cutoff</span><span class="p">,</span> <span class="n">wing_wavenumbers</span> <span class="o">=</span> <span class="n">wing_wavenumbers</span><span class="p">,</span> <span class="n">wing_method</span> <span class="o">=</span> <span class="n">wing_method</span><span class="p">,</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">molefraction</span> <span class="o">=</span> <span class="n">fit_molefraction</span><span class="p">,</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isotope_list</span><span class="p">,</span>
                            <span class="n">natural_abundance</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">natural_abundance</span><span class="p">,</span> <span class="n">abundance_ratio_MI</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">abundance_ratio_MI</span><span class="p">,</span>  <span class="n">Diluent</span> <span class="o">=</span> <span class="n">Diluent</span><span class="p">,</span> 
                            <span class="n">TIPS</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">TIPS</span><span class="p">,</span> <span class="n">compressability_factor</span> <span class="o">=</span> <span class="n">compressability_factor</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_nu</span><span class="p">,</span> <span class="n">fit_coef</span> <span class="o">=</span> <span class="n">HTP_from_DF_select</span><span class="p">(</span><span class="n">linelist_for_sim</span><span class="p">,</span> <span class="n">wavenumbers</span><span class="p">,</span> <span class="n">wing_cutoff</span> <span class="o">=</span> <span class="n">wing_cutoff</span><span class="p">,</span> <span class="n">wing_wavenumbers</span> <span class="o">=</span> <span class="n">wing_wavenumbers</span><span class="p">,</span> <span class="n">wing_method</span> <span class="o">=</span> <span class="n">wing_method</span><span class="p">,</span>
                            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">molefraction</span> <span class="o">=</span> <span class="n">fit_molefraction</span><span class="p">,</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isotope_list</span><span class="p">,</span>
                            <span class="n">natural_abundance</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">natural_abundance</span><span class="p">,</span> <span class="n">abundance_ratio_MI</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">abundance_ratio_MI</span><span class="p">,</span>  <span class="n">Diluent</span> <span class="o">=</span> <span class="n">Diluent</span><span class="p">,</span> 
                            <span class="n">TIPS</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">TIPS</span><span class="p">,</span> <span class="n">compressability_factor</span> <span class="o">=</span> <span class="n">compressability_factor</span><span class="p">)</span>
                <span class="n">fit_coef</span> <span class="o">=</span> <span class="n">fit_coef</span> <span class="o">*</span> <span class="mf">1e6</span>
                
                <span class="c1">## CIA Calculation</span>
                <span class="n">CIA</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">cia</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1">## Baseline Calculation</span>
                <span class="n">baseline_param_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">baseline_order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">baseline_params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;baseline&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">)]</span>
                        <span class="n">spectrum_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                        <span class="n">segment_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">spectrum_num</span> <span class="o">==</span> <span class="n">spectrum_number</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">segment_num</span> <span class="o">==</span> <span class="n">segment</span><span class="p">):</span>
                            <span class="n">baseline_param_array</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="n">param</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">)])</span><span class="o">-</span><span class="mi">97</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                <span class="n">baseline_param_array</span> <span class="o">=</span> <span class="n">baseline_param_array</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverses array to be used for polyval</span>
                <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">baseline_param_array</span><span class="p">,</span> <span class="n">wavenumbers_relative</span><span class="p">)</span>
                <span class="c1">#Etalon Calculation</span>
                <span class="n">fit_etalon_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">etalons</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;amp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">baseline_params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;etalon&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):]):</span>
                        <span class="n">etalon_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">param</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;etalon_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">etalon_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_amp_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span><span class="c1">#(&#39;amp&#39; in param) and (str(etalon_num) in param):</span>
                            <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">etalon_num</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;etalon_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">etalon_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_period_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span><span class="c1">#(&#39;period&#39; in param) and (str(etalon_num) in param):</span>
                            <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">etalon_num</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;etalon_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">etalon_num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_phase_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">):</span><span class="c1">#(&#39;phase&#39; in param) and (str(etalon_num) in param):</span>
                            <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">etalon_num</span><span class="p">][</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>
                <span class="n">etalons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">etalons</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">etalons</span> <span class="o">+=</span> <span class="n">etalon</span><span class="p">(</span><span class="n">wavenumbers_relative</span><span class="p">,</span> <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">],</span> <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">],</span> <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;phase&#39;</span><span class="p">])</span>
                <span class="n">segment_alpha</span> <span class="o">=</span> <span class="n">baseline</span> <span class="o">+</span> <span class="n">etalons</span> <span class="o">+</span> <span class="n">fit_coef</span> <span class="o">+</span> <span class="n">CIA</span>
                <span class="c1">#ILS_Function</span>
                <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_function</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">ILS_function_dict</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">spec_seg_ILS_resolution</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_function</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;_res_0_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spec_seg_ILS_resolution</span>  <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">res_param</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">ILS_function_dict</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]):</span>
                            <span class="n">spec_seg_ILS_resolution</span>  <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_function</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;_res_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res_param</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)])</span>
                    <span class="n">wavenumbers</span><span class="p">,</span> <span class="n">segment_alpha</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2m</span><span class="p">,</span> <span class="n">slit</span> <span class="o">=</span> <span class="n">convolveSpectrumSame</span><span class="p">(</span><span class="n">wavenumbers</span><span class="p">,</span> <span class="n">segment_alpha</span><span class="p">,</span> <span class="n">SlitFunction</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_function</span><span class="p">,</span> <span class="n">Resolution</span> <span class="o">=</span> <span class="n">spec_seg_ILS_resolution</span> <span class="p">,</span><span class="n">AF_wing</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">ILS_wing</span><span class="p">)</span>
                <span class="n">simulated_spectra</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">segment_alpha</span><span class="p">)</span>
                <span class="c1">#Weighted Spectra</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_spectra</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">tau_stats</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">*</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pt_by_pt_weights</span><span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">tau_stats</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">weights</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">pt_by_pt_weights</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="p">((</span><span class="n">segment_alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">alpha_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">*</span><span class="n">weights</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">residuals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]):</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">segment_alpha</span><span class="p">)</span> <span class="o">-</span> <span class="n">alpha_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span>

            <span class="n">total_simulated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_simulated</span><span class="p">,</span> <span class="n">simulated_spectra</span><span class="p">)</span>
            <span class="n">total_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_residuals</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span>
        <span class="n">total_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">total_residuals</span><span class="p">)</span>
        <span class="n">total_simulated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">total_simulated</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total_residuals</span></div>
<div class="viewcode-block" id="Fit_DataSet.fit_data"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.fit_data">[docs]</a>    <span class="k">def</span> <span class="nf">fit_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">wing_cutoff</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_wavenumbers</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span> <span class="n">wing_method</span> <span class="o">=</span> <span class="s1">&#39;wing_cutoff&#39;</span><span class="p">,</span> <span class="n">xtol</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span> <span class="n">maxfev</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">ftol</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Uses the lmfit minimizer to do the fitting through the simulation model function.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : lmfit parameter object</span>
<span class="sd">            the params object is a dictionary comprised of all parameters translated from dataframes into a dictionary format compatible with lmfit.</span>
<span class="sd">        wing_cutoff : float, optional</span>
<span class="sd">            number of voigt half-widths to simulate on either side of each line. The default is 50.</span>
<span class="sd">        wing_wavenumbers : float, optional</span>
<span class="sd">            number of wavenumbers to simulate on either side of each line. The default is 50.</span>
<span class="sd">        wing_method : str, optional</span>
<span class="sd">            Provides choice between the wing_cutoff and wing_wavenumbers line cut-off options. The default is &#39;wing_cutoff&#39;.</span>
<span class="sd">        xtol : float, optional</span>
<span class="sd">             Absolute error in xopt between iterations that is acceptable for convergence. The default is 1e-7.</span>
<span class="sd">        maxfev : float, optional</span>
<span class="sd">            DESCRIPTION. The default is 2000.</span>
<span class="sd">        ftol : The maximum number of calls to the function., optional</span>
<span class="sd">            Absolute error in func(xopt) between iterations that is acceptable for convergence.. The default is 1e-7.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : LMFit result Object</span>
<span class="sd">            contains all fit results as LMFit results object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">minner</span> <span class="o">=</span> <span class="n">Minimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">xtol</span> <span class="o">=</span><span class="n">xtol</span><span class="p">,</span> <span class="n">max_nfev</span> <span class="o">=</span>  <span class="n">maxfev</span><span class="p">,</span> <span class="n">ftol</span> <span class="o">=</span> <span class="n">ftol</span><span class="p">,</span> <span class="n">fcn_args</span><span class="o">=</span><span class="p">(</span><span class="n">wing_cutoff</span><span class="p">,</span> <span class="n">wing_wavenumbers</span><span class="p">,</span> <span class="n">wing_method</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">minner</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;leastsq&#39;</span><span class="p">)</span><span class="c1">#&#39;</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Fit_DataSet.residual_analysis"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.residual_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">residual_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">indv_resid_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the model and residual arrays in each spectrum object with the results of the fit and gives the option of generating the combined absorption and residual plot for each spectrum.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        result : LMFit result Object</span>
<span class="sd">            contains all fit results as LMFit results object.</span>
<span class="sd">        indv_resid_plot : bool, optional</span>
<span class="sd">            True if you want to show residual plots for each spectra.. The default is False.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">residual_array</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">residual</span>

        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>


            <span class="n">spectrum_residual</span><span class="p">,</span> <span class="n">residual_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">residual_array</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_spectra</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">tau_stats</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum_residual</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">spectrum</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pt_by_pt_weights</span><span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">tau_stats</span><span class="p">)</span>
                    <span class="n">weights</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">pt_by_pt_weights</span>
                <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">spectrum_residual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum_residual</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spectrum_residual</span>  <span class="o">=</span> <span class="n">spectrum_residual</span> <span class="o">/</span> <span class="n">weights</span>

            <span class="n">spectrum</span><span class="o">.</span><span class="n">set_residuals</span><span class="p">(</span><span class="n">spectrum_residual</span><span class="p">)</span>
            <span class="n">spectrum</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">spectrum_residual</span> <span class="o">+</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">indv_resid_plot</span><span class="p">:</span>
                <span class="n">spectrum</span><span class="o">.</span><span class="n">plot_model_residuals</span><span class="p">()</span></div>
<div class="viewcode-block" id="Fit_DataSet.update_params"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.update_params">[docs]</a>    <span class="k">def</span> <span class="nf">update_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">base_linelist_update_file</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">,</span> <span class="n">param_linelist_update_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                      <span class="n">CIA_linelist_update_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Updates the baseline and line parameter files based on fit results with the option to write over the file (default) or save as a new file and updates baseline values in the spectrum objects.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        result : LMFit result Object</span>
<span class="sd">            contains all fit results as LMFit results object.</span>
<span class="sd">        base_linelist_update_file : str, optional</span>
<span class="sd">            Name of file to save the updated baseline parameters. Default is to override the input. The default is None.</span>
<span class="sd">        param_linelist_update_file : str, optional</span>
<span class="sd">            Name of file to save the updated line parameters. Default is to override the input. The default is None.</span>
<span class="sd">        cia_linelist_update_file : str, optional</span>
<span class="sd">            Name of file to save the updated CIA parameters.  Default is to override the input.   </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">base_linelist_update_file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base_linelist_update_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_linelist_file</span>
        <span class="k">if</span> <span class="n">param_linelist_update_file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param_linelist_update_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_linelist_file</span>
        <span class="k">if</span> <span class="n">CIA_linelist_update_file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">CIA_linelist_update_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIA_linelist_file</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1">#Baseline</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Pressure&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Temperature&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">segment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span>

            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;molefraction&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;baseline&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;x_shift&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">segment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;etalon&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
                <span class="n">segment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;_res_&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_res_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:])]</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_res_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:][</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">segment</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_res_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:][</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_res_&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;_res_&#39;</span> <span class="o">+</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_res_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:][:</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="p">),</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span>
            <span class="c1">#CIA</span>
            <span class="c1">#Karman CIA</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Karman&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;O2_O2&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="s1">&#39;CIA Pair&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O2_O2&#39;</span><span class="p">),</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="s1">&#39;CIA Pair&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O2_O2&#39;</span><span class="p">),</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Karman&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;O2_N2&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="s1">&#39;CIA Pair&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O2_N2&#39;</span><span class="p">),</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="p">[</span><span class="s1">&#39;CIA Pair&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O2_N2&#39;</span><span class="p">),</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span> 
            <span class="c1">#Line shape Parameters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_line&#39;</span><span class="p">)]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_line&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">vary</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line</span><span class="p">,</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s1">&#39;_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">stderr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">base_linelist_update_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">param_linelist_update_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Karman&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CIAparam_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">CIA_linelist_update_file</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>



        <span class="c1">#Calculate Baseline + Etalons and add to the Baseline term for each spectra</span>
        <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
            <span class="n">wavenumber_segments</span><span class="p">,</span> <span class="n">alpha_segments</span><span class="p">,</span> <span class="n">indices_segments</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">segment_wave_alpha</span><span class="p">()</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">segments</span><span class="p">):</span>
                <span class="n">waves</span> <span class="o">=</span> <span class="n">wavenumber_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span>
                <span class="n">bound_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span>
                <span class="n">bound_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indices_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span>
                <span class="n">wave_rel</span> <span class="o">=</span> <span class="n">waves</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">)</span>
                <span class="n">baseline_param_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">baseline_order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">fit_etalon_parameters</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">etalons</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;amp&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;baseline&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">))</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                        <span class="n">baseline_param_array</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">)])</span><span class="o">-</span><span class="mi">97</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="s1">&#39;etalon&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">))</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">):]):</span>
                        <span class="n">etalon_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">etalon_num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                            <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">etalon_num</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;period&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">etalon_num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                            <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">etalon_num</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;phase&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">etalon_num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                            <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">etalon_num</span><span class="p">][</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">value</span>
                <span class="n">baseline_param_array</span> <span class="o">=</span> <span class="n">baseline_param_array</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reverses array to be used for polyval</span>
                <span class="n">baseline</span><span class="p">[</span><span class="n">bound_min</span><span class="p">:</span> <span class="n">bound_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">baseline_param_array</span><span class="p">,</span> <span class="n">wave_rel</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">etalons</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">baseline</span><span class="p">[</span><span class="n">bound_min</span><span class="p">:</span> <span class="n">bound_max</span> <span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">etalon</span><span class="p">(</span><span class="n">wave_rel</span><span class="p">,</span> <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">],</span> <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;period&#39;</span><span class="p">],</span> <span class="n">fit_etalon_parameters</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;phase&#39;</span><span class="p">])</span>
            <span class="n">spectrum</span><span class="o">.</span><span class="n">set_background</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
        <span class="c1">#Calculate CIA</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Karman&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
                    <span class="n">CIA</span> <span class="o">=</span> <span class="n">o2_cia_karman_model</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_temperature</span><span class="p">(),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_pressure</span><span class="p">(),</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_Diluent</span><span class="p">(),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_SO_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_SO_O2_N2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;S_EXCH_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;EXCH_b_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;EXCH_c_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_b_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_c_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_b_O2_N2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_c_O2_N2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_shift_O2_O2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;SO_shift_O2_N2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;EXCH_shift_O2_N2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                        <span class="n">band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">CIA_model</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span>
                    <span class="n">spectrum</span><span class="o">.</span><span class="n">set_cia</span><span class="p">(</span><span class="n">CIA</span><span class="p">)</span></div>
                    
<div class="viewcode-block" id="Fit_DataSet.generate_beta_output_file"><a class="viewcode-back" href="../../MATS.html#MATS.fit_dataset.Fit_DataSet.generate_beta_output_file">[docs]</a>    <span class="k">def</span> <span class="nf">generate_beta_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta_summary_filename</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Generates a file that summarizes the beta values used in the fitting in the case that beta was used to correct the Dicke narrowing term (beta_formalism = True).</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        beta_summary_filename : str, optional</span>
<span class="sd">            Filename to save the beta information. The default is Beta Summary File.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The generated file has the beta values for each line and spectra that were used in the fitting.  Access to this information is critical as the relationship between beta and nuVC is what generates a spoecific nuVC.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_summary_filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_summary_filename</span> <span class="o">=</span> <span class="s1">&#39;Beta Summary File&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_formalism</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">beta_summary_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineparam_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">#List of all Diluents in Dataset</span>
            <span class="n">diluent_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">diluent</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">diluent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diluent_list</span><span class="p">:</span>
                        <span class="n">diluent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diluent</span><span class="p">)</span>
            <span class="c1">#Determine if line center and nuVC terms are constrained across Dataset or vary for each spectrum</span>
            <span class="n">nu_constrain</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">True</span>


            <span class="k">if</span> <span class="p">((</span><span class="nb">sum</span><span class="p">((</span><span class="s1">&#39;nu&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">beta_summary_list</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nu_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_number_nominal_temperatures</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">sum</span><span class="p">((</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;n_nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">beta_summary_list</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                    <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="nb">print</span> <span class="p">(</span><span class="nb">sum</span><span class="p">((</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;n_nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">beta_summary_list</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="nb">sum</span><span class="p">((</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="s1">&#39;_err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;_vary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;n_nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">beta_summary_list</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">diluent_list</span><span class="p">):</span>
                    <span class="n">nuVC_constrain</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">#Add Column for mass</span>
            <span class="k">for</span> <span class="n">molec</span> <span class="ow">in</span> <span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">beta_summary_list</span> <span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                    <span class="n">beta_summary_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">molec</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;local_iso_id&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">iso</span><span class="p">),</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">molecularMass</span><span class="p">(</span><span class="n">molec</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span> <span class="n">isotope_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">isotope_list</span><span class="p">,</span> <span class="p">)</span>

            <span class="c1">#Single or MS for nu and nuVC</span>
            <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">spectra</span><span class="p">:</span>
                <span class="n">wavenumber_segments</span><span class="p">,</span> <span class="n">alpha_segments</span><span class="p">,</span> <span class="n">indices_segments</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">segment_wave_alpha</span><span class="p">()</span>
                <span class="n">mp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">diluent</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">:</span>
                    <span class="n">mp</span> <span class="o">+=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">[</span><span class="n">diluent</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">[</span><span class="n">diluent</span><span class="p">][</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">segments</span><span class="p">)):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)][</span><span class="s1">&#39;Pressure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Spectrum Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseline_list</span><span class="p">[</span><span class="s1">&#39;Segment Number&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">)][</span><span class="s1">&#39;Temperature&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">wave_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wavenumber_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span>
                    <span class="n">wave_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">wavenumber_segments</span><span class="p">[</span><span class="n">segment</span><span class="p">])</span>

                    <span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp</span> <span class="o">/</span> <span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nu_constrain</span><span class="p">:</span>
                        <span class="n">GammaD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="c1">#change with nu</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">GammaD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;Na&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)]</span> <span class="o">/</span> <span class="n">CONSTANTS</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="c1">#change with nu</span>
                    <span class="n">nuVC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">GammaD</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">diluent</span> <span class="ow">in</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">:</span>
                        <span class="n">abun</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">Diluent</span><span class="p">[</span><span class="n">diluent</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">nuVC_constrain</span><span class="p">:</span>
                            <span class="n">nuVC</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">diluent</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">296</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;n_nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">diluent</span><span class="p">])))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nuVC</span> <span class="o">+=</span> <span class="n">abun</span><span class="o">*</span><span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nuVC_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">diluent</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="mi">296</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;n_nuVC_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">diluent</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">))])))</span>
                    <span class="n">Chi</span> <span class="o">=</span> <span class="n">nuVC</span><span class="o">/</span> <span class="n">GammaD</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="mf">0.0534</span> <span class="o">+</span> <span class="mf">0.1585</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.451</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="mf">1.9595</span> <span class="o">-</span> <span class="mf">0.1258</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mf">0.0056</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.0050</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">3</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0546</span> <span class="o">+</span> <span class="mf">0.0672</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mf">0.0125</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.0003</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">**</span><span class="mi">3</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="mf">0.9466</span> <span class="o">-</span> <span class="mf">0.1585</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4510</span><span class="o">*</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">B</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Chi</span><span class="p">)</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">+</span> <span class="n">D</span>
                    <span class="n">beta_summary_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wave_max</span><span class="p">),</span><span class="s1">&#39;Beta_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">beta_summary_list</span><span class="p">[(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wave_max</span><span class="p">)][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">beta_summary_list</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wave_max</span><span class="p">),</span><span class="s1">&#39;Chi_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">spectrum_number</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">beta_summary_list</span><span class="p">[(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">beta_summary_list</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">wave_max</span><span class="p">)][</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="n">select_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;molec_id&#39;</span><span class="p">,</span> <span class="s1">&#39;local_iso_id&#39;</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">beta_summary_list</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;nuVC&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;n_nuVC&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                    <span class="n">select_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Beta&#39;</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                    <span class="n">select_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">beta_summary_list</span> <span class="o">=</span> <span class="n">beta_summary_list</span><span class="p">[</span><span class="n">select_columns</span><span class="p">]</span>
            <span class="c1">#beta_summary_list  = beta_summary_list[(beta_summary_list[&#39;nu&#39;] &gt;= wave_min) &amp; (beta_summary_list[&#39;nu&#39;] &lt;= wave_max)]</span>
            <span class="n">beta_summary_list</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">beta_summary_filename</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MATS 3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MATS.fit_dataset</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>